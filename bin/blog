#!/bin/sh
set -e
EDITOR=${EDITOR:="vi"}
BLOGHOST=${BLOGHOST:="http://localhost:5000"}
USERNAME=${USERNAME:="test"}
PASSWORD=${PASSWORD:="test"}
S3_BUCKET=${S3_BUCKET:="blog"}
DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"

if [ $# -lt 1 ]
then
        echo "Usage : $0 (new|list|edit|destroy)"
        echo "Current host: ${BLOGHOST}, editor: ${EDITOR}, user: ${USERNAME}"
        exit
fi


function mdtemp()
{
  local tempfile=$(mktemp -t blog)
  local mdtemp="${tempfile}.md"
  mv $tempfile $mdtemp
  echo "$mdtemp"
}

# TODO: finish this to do postprocessing runs
# on auto-uploading assets
# function upload_assets()
# {
#   local local_files=$(echo "<div>" `markdown ${1}` "</div>" | \
#                         xmlstarlet sel -t -v "//*/@href" -n -v "//*/@src" | \
#                         xargs -I{} sh -c "[ -f {} ] && echo '{}'")
#   $DIR/aws mkdir $S3_BUCKET
#   echo "${local_files}" | xargs -I{} $DIR/aws put $S3_BUCKET {}
# }

case "$1" in
  "new") TEMPFILE=$(mdtemp)
         $EDITOR $TEMPFILE && \
           [ -s $TEMPFILE ] && \
           curl -f -vvvv --user "${USERNAME}:${PASSWORD}" --data-binary "@${TEMPFILE}" "${BLOGHOST}/post" && \
           rm $TEMPFILE
         ;;
  "list") curl -H "Accept: text/csv" "${BLOGHOST}/index"
          ;;
  "edit") TEMPFILE=$(mdtemp)
          curl -f -o $TEMPFILE -H "Accept: text/markdown" "${BLOGHOST}/post/${2}"
          $EDITOR $TEMPFILE && \
            [ -s $TEMPFILE ] && \
            curl -f --user "${USERNAME}:${PASSWORD}" --data-binary "@${TEMPFILE}" -X PUT "${BLOGHOST}/post/${2}" && \
            rm $TEMPFILE
          ;;
  "destroy") curl -f --user "${USERNAME}:${PASSWORD}" -X DELETE "${BLOGHOST}/post/${2}"
             ;;
esac

